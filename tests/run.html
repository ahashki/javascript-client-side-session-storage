<head>
<title>SSW Tests</title>
<script type="text/javascript" src="./yui/build/yui/yui.js"></script>
<style type="text/css">
#iframe {
	height: 50px;
	width: 400px;
	border: 1px solid gray;
}
.yui-console {
	position: static !important;
	margin: 1em 0;
}
.yui-console-content {
	width: auto !important;
}
.yui-console-bd {
	height: auto !important;
}
.yui-console-entry-fail .yui-console-entry-meta {
	background-color: #FCC !important;
}
.yui-console-entry-fail .yui-console-entry-cat {
	background-color: #F88 !important;
}
</style>
</head>
<body class="yui-skin-sam">

<h1>SSW Tests</h1>

<iframe name="iframe" id="iframe" src="test-document.html" border="0"></iframe>

<script type="text/javascript">
YUI({
	base : "./yui/build/",
	useBrowserConsole : false
}).use("event", "node", "yuitest", "console", function (Y) {
	
	Y.namespace("sswTest");
	
	/* Mixin helper */
	
	function mixin (source, target) {
		for (var name in source) {
			if (source.hasOwnProperty(name)) {
				target[name] = source[name];
			}
		}
		return target;
	}
		
	/* Helper for tests consisting of two parts with a reload between them */
	
	Y.sswTest.reloadHandler = new Function;

	Y.sswTest.twoParts = function (test, func1, func2) {
		func1();
		Y.sswTest.reloadHandler = function () {
			//alert("reload handler fired");
			test.resume(function () {
				//alert("resuming test\n" + test.name);
				func2();
			});
		};
		Y.sswTest.window.location.reload();
		test.wait();
	};
	
	/* Setup */
	
	Y.sswTest.setup = function () {
		
		/* Get the window object of the test document */
		
		var w = window.frames.iframe;
		Y.sswTest.window = w;
		Y.log("Using Implementation: " + w.ssw.implementation.name);
		
		/* Setup load handler */
		
		/*
		// Doesn't work since the window object changes
		Y.sswTest.window.onload = function () {
			alert("iframe load handler fired");
		};
		*/
		
		/*
		// This doesn't seem to work.
		Y.on("load", function () {
			alert("iframe load handler fired");
			Y.sswTest.reload.handler();
		}, "#iframe");
		*/
		
		// Old-School style works
		document.getElementById("iframe").onload = function () {
			//alert("iframe load handler fired");
			Y.sswTest.reloadHandler();
		};
		
		/* Create Suite */
		
		var testsuite = new Y.Test.Suite("Session Storage Wrapper Unit Tests");
		Y.sswTest.suite = testsuite;
		
		/* Assertions Shortcut */
		
		var A = Y.Assert;
		
		/* Helper Function */
		
		function addTestcase (o) {
			testsuite.add(new Y.Test.Case(o));
		}
		
		/* Ladies and Gentlemen: The Tests. */
		
		/* ************************************************************************************************ */
        
		addTestcase({
			name : "Implementation Auto-Detection (global interface is exposed)",
			testDetection : function () {
				A.isObject(w.ssw);
			} 
		});
		
		/* ------------------------------------------------------------------------------------------------ */

		addTestcase({
			name : "Getting an empty storage object",
			setUp : function () {
				w.ssw.clear();
			},
			testGet : function () {
				var s = w.ssw.get();
				A.isObject(s);
				var memberFound = false;
				for (var propName in s) {
					/* This loop doesn't use hasOwnProperty since the object shouldn't inherit members
					via the prototype chain and the scipt should not augment Object.prototype. */
					memberFound = true;
					Y.log("Found Member on empty object: " + propName + ", own property? " + s.hasOwnProperty(propName));
				}
				if (memberFound) {
					A.isFalse(memberFound);
				}			
			}
		});
			
		/* ------------------------------------------------------------------------------------------------ */
		
		var saveTests = {
			testSaveString : function () {
				var key = "string",
					originalValue = "test";
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
			},
			testSaveNumber : function () {
				var key = "number",
					originalValue = 123.456;
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
			},
			testSaveBoolean : function () {
				var key = "booleanK",
					originalValue = true;
					
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
				
				originalValue = false;
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
			},
			testSaveArray : function () {
				var key = "array",
					originalValue = [ 1.1, "2", true ];
				w.ssw.add(key, originalValue);
				Y.ArrayAssert.itemsAreSame(originalValue, w.ssw.get(key));
			},
			testSaveSingleObject : function () {
				w.ssw.clear();
				var key = "object",
					originalValue = {
						string : "test",
						number : 123.456,
						booleanK : false,
						functionK : new Function,
						regexp : new RegExp,
						date : new Date,
						documentNode : w.document,
						elementNode : document.createElement,
					};
				w.ssw.add(key, originalValue);
				var savedValue = w.ssw.get(key);
				A.areSame(savedValue.string, originalValue.string);
			}			
		};
		
		/* ------------------------------------------------------------------------------------------------ */
		
		var transferTests = {
			testTransferString : function () {
				var key = "string",
					value = "test";
				Y.sswTest.twoParts(this, function () {
					w.ssw.add(key, value);
				}, function () {
					A.areSame(value, w.ssw.get(key));
				});
			},
			testTransferNumber : function () {
				var key = "string",
					value = 123.456;
				Y.sswTest.twoParts(this, function () {
					w.ssw.add(key, value);
				}, function () {					
					A.areSame(value, w.ssw.get(key));
				});
			},
			testTransferBoolean : function () {
				var key = "boolean",
					originalValue = true;
					
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
				
				originalValue = false;
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
			},
			testTransferArray : function () {
				var key = "array",
					originalValue = [ 1.1, "2", true ];
				w.ssw.add(key, originalValue);
				Y.ArrayAssert.itemsAreSame(originalValue, w.ssw.get(key));
			}
		};
		
		/* ------------------------------------------------------------------------------------------------ */
		
		addTestcase(mixin(saveTests, {
			name : "Saving and Reading values, detected implementation, without reloads",
			setUp : function () {
				w.ssw.clear();
			},
			tearDown : function () {
				w.ssw.clear();
			}
		}));

		/* ------------------------------------------------------------------------------------------------ */

		addTestcase(mixin(transferTests, {
			name : "Saving and Reading different values, detected implementation, with reloads",
			setUp : function () {
				w.ssw.clear();
			},
			tearDown : function () {
				w.ssw.clear();
			}
		}));
		
		/* ------------------------------------------------------------------------------------------------ */
		
		
		/* ------------------------------------------------------------------------------------------------ */
		/* ------------------------------------------------------------------------------------------------ */
		
		/* ************************************************************************************************ */
		
	};
	
	/* Run the tests */
	
	Y.sswTest.run = function () {
		var r = new Y.Console({
			verbose : true,
			newestOnTop : false
		});
		Y.Test.Runner.add(Y.sswTest.suite);
		Y.Test.Runner.run();
		r.render('#log');
	};
	
	/* Start */
	
	Y.sswTest.setup();
	Y.sswTest.run();
	
});
</script>

<div id="log"></div>

</body>
</html>