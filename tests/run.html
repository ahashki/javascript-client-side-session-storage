<head>
<title>SSW Tests</title>
<script type="text/javascript" src="./yui/build/yui/yui.js"></script>
<style type="text/css">
#iframe {
	height: 50px;
	width: 400px;
	border: 1px solid gray;
}
.yui-console {
	position: static !important;
	margin: 1em 0;
}
.yui-console-content {
	width: auto !important;
}
.yui-console-bd {
	height: auto !important;
}
</style>
</head>
<body class="yui-skin-sam">

<h1>SSW Tests</h1>

<iframe name="iframe" id="iframe" src="test-document.html" border="0"></iframe>

<script type="text/javascript">
YUI({
	base : "./yui/build/",
	useBrowserConsole : false
}).use("event", "node", "yuitest", "console", function (Y) {
	
	Y.namespace("sswTest");
	
	/* Reload the test document */
	
	Y.sswTest.getTestWindow = function () {
		return window.frames.iframe;
	};
		
	/* Helper for tests consisting of two parts with a reload between them */
	
	Y.sswTest.reloadHandler = new Function;

	Y.sswTest.twoParts = function (test, func1, func2) {
		func1();
		Y.sswTest.reloadHandler = function () {
			//alert("reload handler fired");
			test.resume(function () {
				//alert("resuming test\n" + test.name);
				func2();
			});
		};
		Y.sswTest.window.location.reload();
		test.wait();
	};
	
	/* Setup */
	
	Y.sswTest.setup = function () {
		
		/* Get the window object of the test document */
		
		var w = window.frames.iframe;
		Y.sswTest.window = w;
		Y.log("Using Implementation: " + w.ssw.implementation.name);
				
		/* Setup load handler */
		
		/*
		// Doesn't work since the window object changes
		Y.sswTest.window.onload = function () {
			alert("iframe load handler fired");
		};
		*/
		
		/*
		// This doesn't seem to work.
		Y.on("load", function () {
			alert("iframe load handler fired");
			Y.sswTest.reload.handler();
		}, "#iframe");
		*/
		
		// Old-School style works
		document.getElementById("iframe").onload = function () {
			//alert("iframe load handler fired");
			Y.sswTest.reloadHandler();
		};
		
		/* Create Suite */
		
		var testsuite = new Y.Test.Suite("Session Storage Wrapper Unit Tests");
		Y.sswTest.suite = testsuite;
		
		/* Assertions Shortcut */
		
		var A = Y.Assert;
		
		/* Helper Function */
		
		function addTestcase (o) {
			testsuite.add(new Y.Test.Case(o));
		}
		
		/* Ladies and Gentlemen: The Tests. */
		
		/* ************************************************************************************************ */
        
		addTestcase({
			name : "Implementation Auto-Detection (global interface is exposed)",
			testDetection : function () {
				A.isObject(Y.sswTest.getTestWindow().ssw);
			} 
		});
		
		/* ------------------------------------------------------------------------------------------------ */

		addTestcase({
			name : "Getting an empty storage object",
			setUp : function () {
				w.ssw.clear();
			},
			testGet : function () {
				var s = w.ssw.get();
				A.isObject(s);
				var memberFound = false;
				for (var propName in s) {
					/* This loop doesn't use hasOwnProperty since the object shouldn't inherit members
					via the prototype chain and the scipt should not augment Object.prototype. */
					memberFound = true;
				}
				if (memberFound) {
					Y.isFalse(memberFound);
				}			
			}
		});
			
		/* ------------------------------------------------------------------------------------------------ */
		
		addTestcase({
			name : "Saving, Reading and Removing values, detected implementation, without reloads",
			/*
			setUp : function () {
				w.ssw.clear();
			},
			tearDown : function () {
				w.ssw.clear();
			},
			*/
			testSaveString : function () {
				var k = "string",
					v = "test";
				w.ssw.add(k, v);
				A.areEqual(v, w.ssw.get(k));
				w.ssw.remove(k);
				//alert(w.ssw.get(k));
				//A.areEqual();
			},
			testSaveNumber : function () {
				var k = "number",
					v = 123.456;
				w.ssw.add(k, v);
				A.areEqual(v, w.ssw.get(k));
			},
			testSaveBoolean : function () {
				var k = "boolean",
					v = true;
				w.ssw.add(k, v);
				A.areEqual(v, w.ssw.get(k));
				
				v = false;
				w.ssw.add(k, v);
				A.areEqual(v, w.ssw.get(k));
			},
			testSaveArray : function () {
				var k = "array",
					v = [ 1.1, "2", true ];
				w.ssw.add(k, v);
				var v2 = w.ssw.get(k);
				Y.ArrayAssert.itemsAreEqual(v, v2);
			}
		});

		/* ------------------------------------------------------------------------------------------------ */
		
		addTestcase({
			name : "Saving, Reading and Removing different values, detected implementation, with reloads",
			/*
			setUp : function () {
				w.ssw.clear();
			},
			tearDown : function () {
				w.ssw.clear();
			},
			*/
			testTransferString : function () {
				var s = "test";
				Y.sswTest.twoParts(this, function () {
					w.ssw.add("string", s);
				}, function () {
					A.areEqual(s, w.ssw.get("string"));
				});
			}
			,
			testTransferNumber : function () {
				var n = 123.456;
				Y.sswTest.twoParts(this, function (w) {
					w.ssw.add("number", n);
				}, function (w) {
					A.areEqual(n, w.ssw.get("number"));
				});
			}
		});
		
		/* ------------------------------------------------------------------------------------------------ */
		
		
		/* ------------------------------------------------------------------------------------------------ */
		/* ------------------------------------------------------------------------------------------------ */
		
		/* ************************************************************************************************ */
		
	};
	
	/* Run the tests */
	
	Y.sswTest.run = function () {
		var r = new Y.Console({
			verbose : true,
			newestOnTop : false
		});
		Y.Test.Runner.add(Y.sswTest.suite);
		Y.Test.Runner.run();
		r.render('#log');
	};
	
	/* Start */
	
	Y.sswTest.setup();
	Y.sswTest.run();
	
});
</script>

<div id="log"></div>

</body>
</html>