<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>SSW Tests</title>
<script type="text/javascript" src="./yui/build/yui/yui.js"></script>
<style type="text/css">
#iframe {
	height: 50px;
	width: 400px;
	border: 1px solid gray;
}
.yui-console {
	position: static !important;
	margin: 1em 0;
}
.yui-console-content {
	width: auto !important;
}
.yui-console-bd {
	height: auto !important;
}
.yui-console-entry-fail .yui-console-entry-meta {
	background-color: #FCC !important;
}
.yui-console-entry-fail .yui-console-entry-cat {
	background-color: #F88 !important;
}
</style>
</head>
<body class="yui-skin-sam">

<h1>SSW Tests</h1>

<iframe name="iframe" id="iframe" src="test-document.html" border="0"></iframe>

<script type="text/javascript">
YUI({
	base : "./yui/build/",
	useBrowserConsole : false
}).use("event", "node", "yuitest", "console", function (Y) {
	
	/* Namespace */
	
	Y.namespace("sswTest");
	
	
	/* Helper Functions */
		
	
	/* Helper for tests consisting of two parts with a reload between them */
	
	Y.sswTest.reloadHandler = new Function;

	Y.sswTest.twoParts = function (test, func1, func2) {
		func1();
		Y.sswTest.reloadHandler = function () {
			//Y.log("Reload handler fired");
			test.resume(function () {
				//Y.log("Resuming test: " + test.name);
				Y.sswTest.window.ssw.forceImplementation(test.implementationName);
				func2();
			});
		};
		Y.sswTest.window.location.reload();
		//Y.log("Delay test" + test.name + ", waiting for reload completion");
		test.wait(3000);
	};
	
	
	/* Setup */
	
	Y.sswTest.setup = function () {
		
		/* Get the window object of the test document */
		
		var w = window.frames.iframe;
		Y.sswTest.window = w;
		Y.log("Using Implementation: " + w.ssw.implementation.name);
		
		/* Setup load handler */
		
		Y.on("load", function () {
			//alert("iframe load handler fired");
			Y.sswTest.reloadHandler();
		}, "#iframe");
		
		/* Create Suite */
		
		var testsuite = new Y.Test.Suite("Session Storage Wrapper Unit Tests");
		Y.sswTest.suite = testsuite;
		
		/* Assertions Shortcut */
		
		var A = Y.Assert;
		
		/* Helper Function to Add a Testcase */
		
		function addTestcase (o, template) {
			if (o) {
				Y.mix(o, template);
			}
			testsuite.add(new Y.Test.Case(o));
		}
		
		/* Helper function to Clear the Store */
		
		function clear () {
			w.ssw.clear();
		}
		
		/* Ladies and Gentlemen: The Tests. */
		
		/* ************************************************************************************************ */
        
		addTestcase({
			name : "Implementation Auto-Detection (global interface is exposed)",
			testDetection : function () {
				A.isObject(w.ssw);
			} 
		});
		
		/* ------------------------------------------------------------------------------------------------ */

		addTestcase({
			name : "Getting an empty storage object",
			setUp : function () {
				w.ssw.clear();
			},
			testGet : function () {
				var s = w.ssw.get();
				A.isObject(s);
				var memberFound = false;
				Y.Object.each(s, function (propName) {
					/* Don't check for hasOwnProperty since the object shouldn't inherit members
					via the prototype chain and ssw.js should not augment Object.prototype. */
					memberFound = true;
					Y.log("Found Member on empty object: " + propName + ", own property? " + s.hasOwnProperty(propName));
				}, s, true);
				if (memberFound) {
					A.isFalse(memberFound);
				}
			}
		});
			
		/* ------------------------------------------------------------------------------------------------ */
		
		var saveTests = {
			
			testSaveString : function () {
				var	key = "string",
					originalValue = "test";
					
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
			},
			
			testSaveNumber : function () {
				var	key = "number",
					originalValue = 123.456;
					
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
			},
			
			testSaveBoolean : function () {
				var	key = "booleanK",
					originalValue = true;
					
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
				
				originalValue = false;
				w.ssw.add(key, originalValue);
				A.areSame(originalValue, w.ssw.get(key));
			},
			
			testSaveArray : function () {
				var	key = "array",
					originalValue = [ 1.1, "2", true ];
				
				w.ssw.add(key, originalValue);
				Y.ArrayAssert.itemsAreSame(originalValue, w.ssw.get(key));
			},
			
			testSaveSingleObject : function () {
				w.ssw.clear();
				
				var	key = "object",
					originalValue = {
						string : "test",
						number : 123.456,
						booleanK : false,
						functionK : new Function,
						regexp : new RegExp,
						date : new Date,
						documentNode : w.document,
						elementNode : document.createElement,
						objectConstructor : Object
					};
				w.ssw.add(key, originalValue);
				
				var savedValue = w.ssw.get(key);
				A.areSame(originalValue.string, savedValue.string, "saving a string failed");
				A.areSame(originalValue.number, savedValue.number, "saving a number failed");
				A.areSame(originalValue.booleanK, savedValue.booleanK, "saving a boolean failed");
				A.areSame(originalValue.functionK, savedValue.functionK, "saving a function failed");
				
				A.areSame(originalValue.regexp, savedValue.regexp, "saving a RegExp object failed");
				A.areSame(originalValue.documentNode, savedValue.documentNode, "saving a DOM Document node failed");
				A.areSame(originalValue.elementNode, savedValue.elementNode, "saving a DOM Element node failed");
				A.areSame(originalValue.objectConstructor, savedValue.objectConstructor, "saving a core object failed");
			}			
		};
		
		/* ------------------------------------------------------------------------------------------------ */
		
		var transferTests = {
			
			testTransferString : function () {
				var	key = "string",
					value = "test";
				Y.sswTest.twoParts(this, function () {
					w.ssw.add(key, value);
				}, function () {
					A.areSame(value, w.ssw.get(key));
				});
			},
			
			testTransferNumber : function () {
				var	key = "string",
					value = 123.456;
				Y.sswTest.twoParts(this, function () {
					w.ssw.add(key, value);
				}, function () {					
					A.areSame(value, w.ssw.get(key));
				});
			},
			
			testTransferBoolean : function () {
				var	key = "boolean",
					originalValue = true;
				
				Y.sswTest.twoParts(this, function () {
					w.ssw.add(key, originalValue);
				}, function () {
					A.areSame(originalValue, w.ssw.get(key));
				});
				
				Y.sswTest.twoParts(this, function () {
					originalValue = false;
					w.ssw.add(key, originalValue);
				}, function () {
					A.areSame(originalValue, w.ssw.get(key));
				});
			},
			
			testTransferArray : function () {
				var	key = "array",
					originalValue = [ 1.1, "2", true ];
				
				Y.sswTest.twoParts(this, function () {
					w.ssw.add(key, originalValue);
				}, function () {
					Y.ArrayAssert.itemsAreSame(originalValue, w.ssw.get(key));
				});
			},
			
			testTransferSimpleObject : function () {
				w.ssw.clear();
				var	key = "object",
					originalValue = {
						string : "test",
						number : 123.456,
						booleanK : false,
						nestedObject : {
							string : "test",
							number : 123.456,
							booleanK : false
						}
					};
				
				Y.sswTest.twoParts(this, function () {
					w.ssw.add(key, originalValue);
				}, function () {
					var savedValue = w.ssw.get(key);
					
					Y.ObjectAssert.ownsAll(originalValue, savedValue, "not all members have been transferred");
					A.areSame(originalValue.string, savedValue.string, "transferring a string failed");
					A.areSame(originalValue.number, savedValue.number, "transferring a number failed");
					A.areSame(originalValue.booleanK, savedValue.booleanK, "transferring a boolean failed");
					
					Y.ObjectAssert.ownsAll(originalValue.nestedObject, savedValue.nestedObject, "not all members have been transferred");
					A.areSame(originalValue.nestedObject.string, savedValue.nestedObject.string, "transferring a string failed");
					A.areSame(originalValue.nestedObject.number, savedValue.nestedObject.number, "transferring a number failed");
					A.areSame(originalValue.nestedObject.booleanK, savedValue.nestedObject.booleanK, "transferring a boolean failed");
				});
			},
			
			testTransferPrimitivesAsObjects : function () {
				w.ssw.clear();
				var	key = "object",
					originalValue = {
						string : new String("test"),
						number : new Number(123.456),
						booleanK : new Boolean(false),
					};
				
				Y.sswTest.twoParts(this, function () {
					w.ssw.add(key, originalValue);
				}, function () {
					var savedValue = w.ssw.get(key);
					
					Y.ObjectAssert.ownsAll(originalValue, savedValue, "not all members have been transferred");
					A.areSame(originalValue.string, savedValue.string, "transferring a string object failed");
					A.areSame(originalValue.number, savedValue.number, "transferring a number object failed");
					A.areSame(originalValue.booleanK, savedValue.booleanK, "transferring a boolean object failed");
				});
			},
			_should : {
				error : {
					testTransferHostObject : "Complex host objects cannot be transferred"
				}
			},
			transferSpecialObjects: function () {
				w.ssw.clear();
				var	key = "object",
					originalValue = {
						functionK: function() {
							"This is a function";
						},
					regexp: /regular expression/,
					date: new Date,
					documentNode: w.document,
					elementNode: document.createElement
				};
				
				Y.sswTest.twoParts(this, function () {
					w.ssw.add(key, originalValue);
				}, function () {
					var savedValue = w.ssw.get(key);
					
					A.areEqual(originalValue.functionK, savedValue.functionK, "saving a function failed");
					A.areEqual(originalValue.regexp, savedValue.regexp, "saving a RegExp object failed");
					A.areEqual(originalValue.documentNode, savedValue.documentNode, "saving a DOM Document node failed");
					A.areEqual(originalValue.elementNode, savedValue.elementNode, "saving a DOM Element node failed");
				});
			}

		};
				
		/* ------------------------------------------------------------------------------------------------ */
		
		function testImplementation (implementationName) {
			Y.log("Testing Implementation " + implementationName);
			
			function setupTestcase () {
				//Y.log("setupTestcase: " + this.implementationName);
				
				if (this.implementationName) {
					//Y.log("forceImplementation to " + this.implementationName);
					var result = w.ssw.forceImplementation(this.implementationName);
					//Y.log("forceImplementation result: " + result);
					
					if (!result) {
						Y.log("Implementation " + this.implementationName + " not supported");
						
						// Reload to rebuild the public interface
						w.location.reload();
						return;
					}
				} else {
					// Auto-detect
					//Y.log("Use auto-detected implementation");
					this.implementationName = w.ssw.implementation.name;
				}
				w.ssw.clear();
			}
			
			var displayImplementationName = implementationName || "auto-detect";
			
			addTestcase({
				implementationName : implementationName,
				name : "Testing " + displayImplementationName + ": Saving and Reading different values without reloads",
				setUp : setupTestcase,
				tearDown : clear
			}, saveTests);
			
			addTestcase({
				implementationName : implementationName,
				name : "Testing " + displayImplementationName + ": Transfering different values with reloads",
				setUp : setupTestcase,
				tearDown : clear
			}, transferTests);
			
		}

		/* ------------------------------------------------------------------------------------------------ */
		
		var implementationNames = [null, "domstorage", "userdata", "windowname", "cookie"];
		for (var index in implementationNames) {
		  	testImplementation(implementationNames[index]);
		}
		
		/* ************************************************************************************************ */
		
	};
	
	/* Run the tests */
	
	Y.sswTest.run = function () {
		var r = new Y.Console({
			verbose : true,
			newestOnTop : false
		});
		Y.Test.Runner.add(Y.sswTest.suite);
		Y.Test.Runner.run();
		r.render('#log');
	};
	
	/* Start */
	
	Y.sswTest.setup();
	Y.sswTest.run();
	
});
</script>

<div id="log"></div>

</body>
</html>